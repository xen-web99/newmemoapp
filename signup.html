<script type="module">
  // å¿…è¦ãª import ã‚’ã¾ã¨ã‚ã¦
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
  import { 
    getAuth,
    createUserWithEmailAndPassword,
    sendEmailVerification,
    setPersistence,
    browserLocalPersistence,
    onAuthStateChanged
  } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';

  // Firebaseè¨­å®šï¼ˆ1å›ã ã‘ï¼‰
  const firebaseConfig = {
    apiKey: "AIzaSyAIldTO-8jX6j8gHrOg5D0m-nCCSA-16Go",
    authDomain: "memoapp-c54e6.firebaseapp.com",
    databaseURL: "https://memoapp-c54e6-default-rtdb.firebaseio.com",
    projectId: "memoapp-c54e6",
    storageBucket: "memoapp-c54e6.firebasestorage.app",
    messagingSenderId: "490272180038",
    appId: "1:490272180038:web:f8c82853288e77d9440747"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  // â˜… æ°¸ç¶šåŒ–ã‚’ LOCAL ã«æ˜ç¤ºè¨­å®šï¼ˆãƒ–ãƒ©ã‚¦ã‚¶é–‰ã˜ã¦ã‚‚ä¿æŒï¼‰
  setPersistence(auth, browserLocalPersistence)
    .then(() => {
      console.log("æ–°è¦ç™»éŒ²ç”»é¢: ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ LOCAL ã«è¨­å®šï¼ˆé•·æœŸé–“ä¿æŒï¼‰");
    })
    .catch((err) => {
      console.error("æ°¸ç¶šåŒ–è¨­å®šå¤±æ•—:", err);
    });

  // æ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰ãƒ¡ã‚¤ãƒ³ç”»é¢ã¸è‡ªå‹•é·ç§»ï¼ˆç™»éŒ²å¾Œã™ãé£›ã°ã™ç”¨ï¼‰
  onAuthStateChanged(auth, (user) => {
    if (user && user.emailVerified) {
      console.log("ç™»éŒ²æ¸ˆã¿ï¼†èªè¨¼æ¸ˆã¿ â†’ newmemo.html ã¸è‡ªå‹•ç§»å‹•");
      window.location.href = "newmemo.html";
    }
  });

  const createBtn = document.getElementById("createBtn");
  const errorMessage = document.getElementById("errorMessage");

  createBtn.addEventListener("click", async function() {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();
    
    errorMessage.textContent = "";

    if (!email || !password) {
      errorMessage.textContent = "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
      return;
    }

    if (password.length < 8 || password.length > 12) {
      errorMessage.textContent = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8ã€œ12æ–‡å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„";
      return;
    }

    if (!/[a-z]/.test(password)) {
      errorMessage.textContent = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«ã¯è‹±å°æ–‡å­—ã‚’å«ã‚ã¦ãã ã•ã„";
      return;
    }

    let typeCount = 0;
    if (/[A-Z]/.test(password)) typeCount++;
    if (/[0-9]/.test(password)) typeCount++;
    if (/[^a-zA-Z0-9]/.test(password)) typeCount++;

    if (typeCount < 2) {
      errorMessage.textContent = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«ã¯å¤§æ–‡å­—/æ•°å­—/è¨˜å·ã®ã†ã¡2ç¨®é¡ä»¥ä¸Šã‚’å«ã‚ã¦ãã ã•ã„";
      return;
    }

    createBtn.disabled = true;
    createBtn.textContent = "ä½œæˆä¸­...";

    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      
      await sendEmailVerification(userCredential.user);
      
      alert('âœ… ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸï¼\n\nğŸ“§ ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚\nãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦èªè¨¼ã—ã¦ãã ã•ã„ã€‚\n\nâ€»è¿·æƒ‘ãƒ¡ãƒ¼ãƒ«ãƒ•ã‚©ãƒ«ãƒ€ã‚‚ç¢ºèªã‚’ï¼');
      
      // ã“ã“ã§å³ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã›ãšã€onAuthStateChanged ã«ä»»ã›ã‚‹ï¼ˆèªè¨¼å¾Œè‡ªå‹•ã§é£›ã¶ï¼‰
      // window.location.href = "index.html";  â† ã“ã‚Œã¯å‰Šé™¤orã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆæ¨å¥¨
    } catch (error) {
      let message = "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ";
      
      if (error.code === 'auth/email-already-in-use') {
        message = "ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™";
      } else if (error.code === 'auth/invalid-email') {
        message = "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“";
      } else if (error.code === 'auth/weak-password') {
        message = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¼±ã™ãã¾ã™";
      } else {
        console.error("ç™»éŒ²ã‚¨ãƒ©ãƒ¼è©³ç´°:", error.code, error.message);
      }
      
      errorMessage.textContent = message;
      createBtn.disabled = false;
      createBtn.textContent = "ä½œæˆ";
    }
  });
</script>
